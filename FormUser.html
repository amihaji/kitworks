<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - WETools</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .login-card {
            width: 100%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="card login-card shadow">
        <div class="card-body p-5">
            <div class="text-center mb-4">
                <img src="images/logo-beratidealku.png" alt="Logo" width="200">
                <h3 class="mt-3">User Login</h3>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="userId" class="form-label">User ID</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <input type="text" class="form-control" id="userId" name="userId" required minlength="4" maxlength="6">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">Password</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" class="form-control" id="password" name="password" required minlength="6" maxlength="10">
                    </div>
                </div>
                <div id="message" class="mb-3"></div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg" id="loginButton">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Login
                    </button>
                </div>
            </form>
            <div class="text-center mt-3">
                <a href="index.html">‚Üê Kembali ke Survey</a>
            </div>
        </div>
    </div>

<script>
//***********  Deklarasi variabel global ****************
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbyhCf3abwBYsZKF1D7_micutYo0oXv6SGhxNA1LKSNybVSXdIWyQ7t-CY7ECQN-gQuvFw/exec';
const loginForm       = document.getElementById('loginForm');
const loginButton     = document.getElementById('loginButton');
const spinner         = loginButton.querySelector('.spinner-border');
const messageDiv      = document.getElementById('message');
// ******************************************************

loginForm.addEventListener('submit', function(e) {
    e.preventDefault();

    spinner.style.display = 'inline-block';
    loginButton.disabled = true;
    messageDiv.innerHTML = '';

    const userId = document.getElementById('userId').value.trim();
    const password = document.getElementById('password').value.trim();

    const callbackName = 'login_cb_' + Date.now();
    const script = document.createElement('script');

    script.src = `${URL_APPS_SCRIPT}?action=checkLogin&userId=${encodeURIComponent(userId)}&userPass=${encodeURIComponent(password)}&callback=${callbackName}`;

    window[callbackName] = (response) => {
        if (response.status === 'success' && response.loggedIn) {
            sessionStorage.setItem('userToken', response.token);
            sessionStorage.setItem('userLevel', response.level);
            sessionStorage.setItem('userId', response.userId);

            if (response.level === 'Admin') {
                window.location.href = 'DashWE.html';
            } else if (response.level === 'Member') {
                window.location.href = 'DashCRM.html';
            } else if (response.level === 'User') {
                window.location.href = 'DashUser.html';
            } else {
                showMessage('Level user tidak dikenali.', 'danger');
                resetButton();
            }
        } else {
            showMessage(response.message || 'User ID atau Password salah.', 'danger');
            resetButton();
        }
        cleanup(script, callbackName);
    };

    script.onerror = () => {
        showMessage('Gagal menghubungi server. Periksa koneksi Anda.', 'danger');
        resetButton();
        cleanup(script, callbackName);
    };

    document.body.appendChild(script);
});

function cleanup(script, callbackName) {
    if (script.parentNode) script.parentNode.removeChild(script);
    delete window[callbackName];
}

function showMessage(msg, type) {
    messageDiv.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
}

function resetButton() {
    spinner.style.display = 'none';
    loginButton.disabled = false;
}
</script>
</body>
</html>
