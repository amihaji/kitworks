<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>KitWorks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #003366;
    }
    .menu {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    .menu button {
      background-color: #003366;
      color: white;
      border: none;
      padding: 15px 25px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
    }
    .menu button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    .menu button i {
      margin-right: 10px;
    }

    .login-form {
      max-width: 400px;
      margin: 30px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #btnLogin {
      width: 100%;
      padding: 10px;
      background-color: #003366;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #btnLogin .spinner {
      display: none;
      margin-left: 8px;
    }

    #btnLogin.btn-loading .spinner {
      display: inline-block;
    }

    #btnLogin.btn-loading .btn-text {
      display: none;
    }

    .notification {
      margin: 15px auto;
      padding: 10px 15px;
      border-radius: 6px;
      font-weight: bold;
      width: fit-content;
    }

    .notif-error {
      background-color: #dc3545;
      color: white;
    }

    .notif-success {
      background-color: #007bff;
      color: white;
    }

    .notif-warning {
      background-color: orange;
      color: black;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>KitWorks</h1>

    <div id="notifArea"></div>

    <div class="login-form" id="loginForm">
      <div class="form-group">
        <input type="text" id="userId" placeholder="User ID" />
      </div>
      <div class="form-group">
        <input type="password" id="userPass" placeholder="Password" />
      </div>
      <button id="btnLogin">
        <span class="btn-text">Login</span>
        <span class="spinner"><i class="fas fa-spinner fa-spin"></i></span>
      </button>
    </div>

    <div class="menu" id="mainMenu" style="display:none;">
      <button id="btnMenu1"><i class="fas fa-cog"></i> Setup User</button>
      <button id="btnMenu2"><i class="fas fa-chart-line"></i> Laporan</button>
      <button id="btnMenu3"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ********* Deklarasi  Public **********
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbwJUBnUrtKsH5Z5onko_Q4orQWva0VA8wnRefJWDnGjeBdMjomvpld6vuLynXlYCqDrbg/exec';
// **************************************

// Tampilkan notifikasi CSS
function showNotification(type, message, duration = 2000) {
  const box = document.getElementById('notificationBox');
  box.className = 'notification-message'; // reset class
  if (type === 'error') box.classList.add('notification-error');
  else if (type === 'success') box.classList.add('notification-success');
  else if (type === 'warning') box.classList.add('notification-warning');

  box.innerText = message;
  box.style.display = 'block';

  setTimeout(() => { box.style.display = 'none'; }, duration);
}

// Show About form
function showAbout() {
  document.getElementById('aboutOverlay').style.display = 'flex';
}

// Hide About form
function hideAbout() {
  document.getElementById('aboutOverlay').style.display = 'none';
}

// Toggle login form visibility
function toggleLogin() {
  const loginOverlay = document.getElementById('loginOverlay');
  const btnLogin = document.getElementById('btnLogin');

  if (loginOverlay.style.display === 'block') {
    loginOverlay.style.display = 'none';
    btnLogin.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
  } else {
    loginOverlay.style.display = 'block';
    btnLogin.innerHTML = '<i class="fas fa-times"></i> Tutup';
  }
}

// Update login button after successful login
function updateLoginButton() {
  const btnLogin = document.getElementById('btnLogin');
  btnLogin.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
  btnLogin.onclick = logout;
}

// Event listener saat DOM selesai dimuat
document.addEventListener('DOMContentLoaded', function () {
  // About button
  document.querySelector('a[href="#about"]').addEventListener('click', function (e) {
    e.preventDefault();
    showAbout();
  });

  // Close about
  document.getElementById('btnCloseAbout').addEventListener('click', hideAbout);

  // Restore tombol menu jika sudah login
  const userToken = sessionStorage.getItem('userToken');
  if (userToken) {
    try {
      const akses = JSON.parse(sessionStorage.getItem('aksesList') || '{}');
      for (const key in akses) {
        const btn = document.getElementById(key);
        if (btn && akses[key] === "Y") {
          btn.classList.remove('disabled');
        }
      }
      updateLoginButton();
    } catch (e) {
      console.error('Error parsing aksesList', e);
    }
  }

  // LOGIN handler
  document.getElementById('btnLoginSubmit').addEventListener('click', function () {
    const userId = document.getElementById('userId').value.trim();
    const userPass = document.getElementById('userPass').value.trim();
    const btnLoginSubmit = this;

    if (!userId || !userPass) {
      showNotification('warning', 'User ID dan Password harus diisi!');
      return;
    }

    // Ganti tombol login jadi spinner
    btnLoginSubmit.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`;
    btnLoginSubmit.disabled = true;

    const callbackName = 'cb_' + Date.now();
    const script = document.createElement('script');
    script.src = `${URL_APPS_SCRIPT}?action=checkLogin&userId=${encodeURIComponent(userId)}&userPass=${encodeURIComponent(userPass)}&callback=${callbackName}`;

    window[callbackName] = function (response) {
      if (response.status === 'success' && response.loggedIn) {
        sessionStorage.setItem('userId', response.userId);
        sessionStorage.setItem('userToken', response.token);
        sessionStorage.setItem('userLevel', response.level);
        if (response.access) {
          sessionStorage.setItem('aksesList', JSON.stringify(response.access));
        }

        const akses = response.access || {};
        for (const key in akses) {
          const btn = document.getElementById(key);
          if (btn && akses[key] === "Y") {
            btn.classList.remove('disabled');
          }
        }

        document.getElementById('loginOverlay').style.display = 'none';
        updateLoginButton();
      } else {
        showNotification('error', response.message || 'User ID atau Password salah!');
      }

      // Reset tombol login
      btnLoginSubmit.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
      btnLoginSubmit.disabled = false;

      document.body.removeChild(script);
      delete window[callbackName];
    };

    script.onerror = () => {
      showNotification('error', 'Gagal terhubung ke server!');
      btnLoginSubmit.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
      btnLoginSubmit.disabled = false;
      document.body.removeChild(script);
      delete window[callbackName];
    };

    document.body.appendChild(script);
  });
});

// Logout handler
function logout() {
  sessionStorage.clear();
  const buttons = ['btnFLC', 'btnEstiH', 'btnWE', 'btnDashWE', 'btnCRM', 'btnSetup'];
  buttons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.classList.add('disabled');
  });

  const btnLogin = document.getElementById('btnLogin');
  btnLogin.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
  btnLogin.onclick = toggleLogin;
  document.getElementById('loginOverlay').style.display = 'none';
}
</script>
</body>
</html>
