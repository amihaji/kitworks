<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KitWorks - Main Menu</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<style>
body { background-color: #f8f9fa; }
.title-box { 
  background-color: #003366; 
  color: white; 
  padding: 10px 15px; 
  border-radius: 5px; 
  display: flex; 
  align-items: center; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
}
.title-box i { margin-right: 10px; }
.button-box { 
  background: white; 
  border-radius: 5px; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
  padding: 15px; 
  margin: 20px auto; 
  max-width: 400px; 
}
.btn.disabled { 
  pointer-events: none; 
  opacity: 0.5; 
}
</style>
</head>
<body>

<div class="container mt-4">
    <div class="title-box">
        <i class="fas fa-cogs"></i>
        <h4 class="mb-0">KitWorks - Main Menu</h4>
    </div>

    <div class="button-box text-center">
        <div class="d-grid gap-2">
            <a href="https://amihaji.github.io/kitworks/FormUser.html" class="btn btn-primary">Login</a>
            <a href="https://amihaji.github.io/kitworks/setup.html"    class="btn btn-secondary disabled" id="btnsetting">Setup User</a>
            <a href="https://amihaji.github.io/flc/index.html"         class="btn btn-secondary disabled" id="btnsetting">FLC Programme</a>
            <a href="https://amihaji.github.io/wetools/index.html"     class="btn btn-secondary disabled" id="btnwetools">WE Tools</a>
            <a href="https://amihaji.github.io/wetools/DashWE.html"    class="btn btn-secondary disabled" id="btnfollowup">FollowUp Tools</a>
            <a href="https://amihaji.github.io/crmtools/index.html"    class="btn btn-secondary disabled" id="btncrmtools">CRM Tools</a>
            <a href="https://amihaji.github.io/estihtools/index.html"  class="btn btn-secondary disabled" id="btnestihtools">EstiH Tools</a>
            <button class="btn btn-danger logout-btn">Logout</button>
        </div>
    </div>
</div>

<script>
// *********  URL Google Apps Script JSONP **********
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbzZ4zcCygki0V5ssAhS94d8lc9tT5aiHwlr-9YdyLmmY6EaYyZpxXfjPsL1Ne7vF4kkNg/exec';
// **************************************************
document.addEventListener("DOMContentLoaded", function() {
    manageMenuAccess();

    document.querySelectorAll('.logout-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            sessionStorage.clear();
            location.reload();
        });
    });
});

function manageMenuAccess() {
    const userId = sessionStorage.getItem('userId');
    const userToken = sessionStorage.getItem('userToken');

    if (userId && userToken) {
        const callbackName = 'cb_' + Date.now();
        const script = document.createElement('script');
        script.src = `${URL_APPS_SCRIPT}?action=getUserAccess&userId=${encodeURIComponent(userId)}&token=${encodeURIComponent(userToken)}&callback=${callbackName}`;

        window[callbackName] = (response) => {
            if (response.status === 'success') {
                const access = response.access; // { estihtools: "Y", wetools: "N", ... }
                for (const [app, status] of Object.entries(access)) {
                    const btn = document.getElementById(`btn${app}`);
                    if (btn && status === 'Y') {
                        btn.classList.remove('disabled');
                        btn.classList.replace('btn-secondary', 'btn-success');
                    }
                }
            } else {
                console.error(response.message);
                sessionStorage.clear();
            }
            document.body.removeChild(script);
            delete window[callbackName];
        };
        script.onerror = () => {
            console.error("Gagal mengambil hak akses user.");
            document.body.removeChild(script);
            delete window[callbackName];
        };
        document.body.appendChild(script);
    }
}
</script>

</body>
</html>
