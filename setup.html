<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setup User - WE Tools</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body { background-color: #f8f9fa; }
.table-hover tbody tr:hover { 
    background-color: #f2f2f2; 
    cursor: pointer; 
}
.actions-col { 
    width: 180px; 
    text-align: center; 
    white-space: nowrap; 
}
.action-icon {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 25px;
    height: 25px;
    opacity: 0; /* Semua icon disembunyikan default */
    transition: opacity 0.2s, color 0.2s, background-color 0.2s;
    margin: 0 5px;
    cursor: pointer;
    color: #6c757d;
    border-radius: 50%;
    padding: 4px;
}
tr:hover .action-icon:not(.disabled-action) {
    opacity: 1; /* Icon ENABLED muncul saat hover baris */
}
tr:hover .action-icon.disabled-action {
    opacity: 0.3; /* Icon DISABLED samar saat hover baris */
}
.action-icon:hover {
    color: red;
    background-color: #e0e0e0;
}
.action-icon.disabled-action {
    pointer-events: none;
}
.action-icon.disabled-action:hover {
    color: #6c757d;
    background-color: transparent;
    cursor: not-allowed;
}

.sticky-header th { 
    position: sticky; top: 0; 
    background-color: #003366; 
    color: white; 
    z-index: 2; 
}
.title-box { 
    background-color: #003366; 
    color: white; 
    padding: 10px 15px; 
    border-radius: 5px; 
    display: flex; 
    align-items: center; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
}
.title-box i { margin-right: 10px; }
.button-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
    margin: 15px 0; 
}
.btn-group-vertical-responsive { 
    display: flex; 
    flex-direction: row; 
    gap: 10px; 
}
@media (max-width: 576px) {
    .btn-group-vertical-responsive { 
        flex-direction: column; 
    }
    .btn-group-vertical-responsive button, .btn-group-vertical-responsive a { 
        width: 100% !important; 
    }
}
.table-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
}
.table-wrapper { 
    max-height: 450px; 
    overflow-y: auto; 
}

.loading-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.7); z-index: 1060;
    display: flex; justify-content: center; align-items: center;
}
</style>
</head>

<body class="p-2 p-sm-3">
<div class="container">

    <!-- Header Box -->
    <div class="title-box mb-3">
        <i class="fas fa-user-cog fa-lg"></i>
        <h6 class="mb-0">Setup User</h6>
    </div>

    <!-- Button Box -->
    <div class="button-box d-flex justify-content-between align-items-center btn-group-vertical-responsive">
        <button class="btn btn-primary" id="addUserButton"><i class="fas fa-plus"></i> Add User</button>
        <a href="https://amihaji.github.io/kitworks/index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Close</a>
    </div>

    <!-- Table Box -->
    <div class="table-box">
        <div class="table-wrapper">
            <table class="table table-hover table-striped table-bordered align-middle text-center">
                <thead class="sticky-header">
                    <tr>
                        <th>User ID</th>
                        <th>Nama User</th>
                        <th>Email</th>
                        <th>HP</th>
                        <th>Password</th>
                        <th>Level</th>
                        <th>Salah</th>
                        <th class="actions-col">Aksi</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="8">Memuat data...</td></tr>
                    <!-- Loading Overlay -->
                    <div id="loadingOverlay" class="loading-overlay">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    </div>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="userForm" class="modal-content">
      <div class="modal-header" style="background-color:#003366; color:white;">
        <h6 class="modal-title">Tambah User</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body">
          <input type="hidden" id="mode" value="add">
          <div class="mb-2">
              <label class="form-label">User ID</label>
              <input type="text" id="userId" class="form-control" required>
          </div>
          <div class="mb-2">
              <label class="form-label">Nama User</label>
              <input type="text" id="userName" class="form-control" required>
          </div>
          <div class="mb-2">
              <label class="form-label">Email User</label>
              <input type="email" id="userEmail" class="form-control" required>
          </div>
          <div class="mb-2">
              <label class="form-label">HP User</label>
              <input type="text" id="userHP" class="form-control" required>
          </div>
          <div class="mb-2">
              <label class="form-label">Password</label>
              <input type="text" id="userPass" class="form-control" required>
          </div>
          <div class="mb-2">
              <label class="form-label">Level</label>
              <select id="userLevel" class="form-select" required>
                  <option value="Admin">Admin</option>
                  <option value="Member">Member</option>
                  <option value="User">User</option>
              </select>
          </div>
          <div class="mb-2">
              <label class="form-label">Salah</label>
              <input type="number" id="userSalah" class="form-control" min="0" max="3" value="0" required>
          </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Simpan</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      </div>
    </form>
  </div>
</div>

<script>
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbyALtnW1lskrHALbI7DUYUK-62ujP2eti3Ii9MFC9bNA84m_ceDN7M3v0ydsO0B9boS/exec';
const loadingOverlay  = document.getElementById('loadingOverlay');

// Loading Spinner
function showLoading(show) {
    loadingOverlay.style.display = show ? 'flex' : 'none';
}

// Load Tabel Data
function loadUserTable() {
    showLoading(true);
    const callbackName = 'cb_' + Date.now();
    const script = document.createElement('script');
    script.src = `${URL_APPS_SCRIPT}?action=getTabelUser&callback=${callbackName}`;

    script.onerror = () => { alert('Gagal mengambil data.'); showLoading(false); };

    window[callbackName] = function(data) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">Tidak ada data user.</td></tr>';
        } else {
            data.forEach(row => {
                const userId    = row[0];
                const namaUser  = row[1];
                const emailUser = row[2];
                const hpUser    = row[3];
                const passUser  = row[4];
                const levelUser = row[5];
                let salah        = parseInt(row[6]) || 0;

                // Default: Edit/Hapus aktif, Unlock/Kirim nonaktif
                let editState = '';
                let deleteState = '';
                let unlockState = 'disabled-action';
                let sendState = 'disabled-action';

                // Cek localStorage jika baru unlock (siap kirim notif)
                const unlockFlag = localStorage.getItem('notifReady_' + userId);

                if (salah >= 3) {
                    // User terkunci
                    editState = 'disabled-action';
                    deleteState = 'disabled-action';
                    unlockState = ''; // enable unlock
                    sendState = 'disabled-action';
                } else if (unlockFlag === 'true') {
                    // Setelah unlock, siap kirim
                    editState = 'disabled-action';
                    deleteState = 'disabled-action';
                    unlockState = 'disabled-action';
                    sendState = ''; // enable kirim
                }
                // Else: default (edit/hapus aktif, unlock/kirim nonaktif)

                const rowHTML = `
                <tr id="row_${userId}">
                    <td>${userId}</td>
                    <td>${namaUser}</td>
                    <td>${emailUser}</td>
                    <td>${hpUser}</td>
                    <td>${passUser}</td>
                    <td>${levelUser}</td>
                    <td>${salah}</td>
                    <td class="actions-col">
                        <i class="fas fa-edit action-icon ${editState}" title="Edit User"
                          onclick="editUser('${userId}','${namaUser}','${emailUser}','${hpUser}','${passUser}','${levelUser}','${salah}')">
                        </i>
                        <i class="fas fa-trash-alt action-icon ${deleteState}" title="Hapus User" 
                          onclick="deleteUser('${userId}')">
                        </i>
                        <i class="fas fa-unlock action-icon ${unlockState}" title="Unlock User" 
                          onclick="unlockUser('${userId}')">
                        </i>
                        <i class="fas fa-paper-plane action-icon ${sendState}" title="Kirim Notifikasi" 
                          onclick="sendNotif('${userId}','${namaUser}','${emailUser}','${hpUser}','${passUser}')">
                        </i>
                    </td>
                </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', rowHTML);
            });
        }

        document.body.removeChild(script);
        delete window[callbackName];
        showLoading(false);
    };
    document.body.appendChild(script);
}

// ADD / EDIT USER
document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const mode      = document.getElementById('mode').value;
    const userId    = document.getElementById('userId').value.trim();
    const userName  = document.getElementById('userName').value.trim();
    const userEmail = document.getElementById('userEmail').value.trim();
    const userHP    = document.getElementById('userHP').value.trim();
    const userPass  = document.getElementById('userPass').value.trim();
    const userLevel = document.getElementById('userLevel').value;
    const userSalah = document.getElementById('userSalah').value || 0;

    const action = mode === 'add' ? 'addUser' : 'editUser';
    const callbackName = 'cb_' + Date.now();
    const script = document.createElement('script');
    script.src = `${URL_APPS_SCRIPT}?action=${action}&userId=${encodeURIComponent(userId)}&userName=${encodeURIComponent(userName)}&userEmail=${encodeURIComponent(userEmail)}&userHP=${encodeURIComponent(userHP)}&userPass=${encodeURIComponent(userPass)}&userLevel=${encodeURIComponent(userLevel)}&userSalah=${encodeURIComponent(userSalah)}&callback=${callbackName}`;

    window[callbackName] = function(response) {
        if (response.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            loadUserTable();
        } else {
            alert('Gagal menyimpan data: ' + (response.message || 'Unknown error'));
        }
        document.body.removeChild(script);
        delete window[callbackName];
    };
    document.body.appendChild(script);
});

// DELETE USER
function deleteUser(userId) {
    if (!confirm(`Hapus user ${userId}?`)) return;
    const callbackName = 'cb_' + Date.now();
    const script = document.createElement('script');
    script.src = `${URL_APPS_SCRIPT}?action=deleteUser&userId=${encodeURIComponent(userId)}&callback=${callbackName}`;
    window[callbackName] = function(response) {
        if (response.status === 'success') {
            loadUserTable();
        } else {
            alert('Gagal menghapus data: ' + (response.message || 'Unknown error'));
        }
        document.body.removeChild(script);
        delete window[callbackName];
    };
    document.body.appendChild(script);
}

// UNLOCK USER
function unlockUser(userId) {
    // Cari data user lengkap dari tabel yang sudah terload
    const rows   = document.querySelectorAll('#userTableBody tr');
    let userData = null;
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells[0].innerText === userId) {
            userData = {
                userId:    cells[0].innerText,
                userName:  cells[1].innerText,
                userEmail: cells[2].innerText,
                userHP:    cells[3].innerText,
                userPass:  cells[4].innerText,
                userLevel: cells[5].innerText,
                userSalah: 0 // reset menjadi 0
            };
        }
    });

    if (!userData) {
        alert('User tidak ditemukan di tabel.');
        return;
    }

    const callbackName = 'cb_' + Date.now();
    const script = document.createElement('script');
    script.src   = `${URL_APPS_SCRIPT}?action=editUser&userId=${encodeURIComponent(userData.userId)}&userName=${encodeURIComponent(userData.userName)}&userEmail=${encodeURIComponent(userData.userEmail)}&userHP=${encodeURIComponent(userData.userHP)}&userPass=${encodeURIComponent(userData.userPass)}&userLevel=${encodeURIComponent(userData.userLevel)}&userSalah=${encodeURIComponent(userData.userSalah)}&callback=${callbackName}`;
    window[callbackName] = function(response) {
        if (response.status === 'success') {
            alert(`User ${userId} berhasil di-unlock.`);
            localStorage.setItem('notifReady_' + userId, 'true');
            loadUserTable();
        } else {
            alert('Gagal unlock user: ' + (response.message || 'Unknown error'));
        }
        document.body.removeChild(script);
        delete window[callbackName];
    };
    document.body.appendChild(script);
}

// Mengecek localStorage sebagai flag setelah unlock, reset setelah kirim
function kirimNotifikasiSiap(userId) {
    return localStorage.getItem('notifReady_' + userId) === 'true';
}

// Kirim notifikasi ke WA & Email User
function sendNotif(userId, userName, userEmail, userHP, userPass) {
    if (!confirm(`Kirim notifikasi reset ke WA & Email user ${userId}?`)) return;

    const callbackName = 'cb_' + Date.now();
    const script = document.createElement('script');

    const message = 
        `*Notifikasi Reset User*\n`+
        `----------------------\n`+
        `Telah direset User atas\n`+
        `- Nama : ${userName}\n`+
        `- User ID: ${userId}\n`+
        `- Pass: ${userPass}\n`+
        `Terima Kasih`;

    script.src = `${URL_APPS_SCRIPT}?action=sendNotifUser&userId=${encodeURIComponent(userId)}&userName=${encodeURIComponent(userName)}&userEmail=${encodeURIComponent(userEmail)}&userHP=${encodeURIComponent(userHP)}&userPass=${encodeURIComponent(userPass)}&message=${encodeURIComponent(message)}&callback=${callbackName}`;
    window[callbackName] = function(response) {
        if (response.status === 'success') {
            alert('Notifikasi berhasil dikirim.');
            localStorage.removeItem('notifReady_' + userId);
            loadUserTable();
        } else {
            alert('Gagal mengirim notifikasi: ' + (response.message || 'Unknown error'));
        }
        document.body.removeChild(script);
        delete window[callbackName];
    };
    document.body.appendChild(script);
}

// OPEN MODAL ADD
document.getElementById('addUserButton').addEventListener('click', () => {
    document.getElementById('userForm').reset();
    document.getElementById('mode').value = 'add';
    document.getElementById('userId').readOnly = false;
    document.querySelector('#userModal .modal-title').innerText = 'Tambah User';
    new bootstrap.Modal(document.getElementById('userModal')).show();
});

// OPEN MODAL EDIT
function editUser(userId, userName, userEmail, userHP, userPass, userLevel, userSalah) {
    document.getElementById('mode').value = 'edit';
    document.getElementById('userId').value = userId;
    document.getElementById('userId').readOnly = true;
    document.getElementById('userName').value = userName;
    document.getElementById('userEmail').value = userEmail;
    document.getElementById('userHP').value = userHP;
    document.getElementById('userPass').value = userPass;
    document.getElementById('userLevel').value = userLevel;
    document.getElementById('userSalah').value = userSalah || 0;
    document.querySelector('#userModal .modal-title').innerText = 'Edit User';
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

// Load Tabel dan Load Halaman
document.addEventListener('DOMContentLoaded', loadUserTable);

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
