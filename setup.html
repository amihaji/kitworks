<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setup User - WE Tools</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body { 
    background-color: #f8f9fa; 
}
.table-hover tbody tr:hover { 
    background-color: #f2f2f2; 
    cursor: pointer; 
}
.actions-col { 
    width: 220px; 
    text-align: center; 
    white-space: nowrap; 
}

/************************/
/* Pengaturan Icon-icon */
/************************/
/* Default semua icon (enabled & disabled) tidak terlihat */
/* Ikon default (hidden) */
.action-icon {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 25px;
    height: 25px;
    opacity: 0;
    transition: opacity 0.2s, color 0.2s, background-color 0.2s;
    margin: 0 5px;
    cursor: pointer;
    color: #6c757d;
    border-radius: 50%;
    padding: 4px;
}

/* Saat hover ke baris, semua icon termasuk yang disabled akan muncul */
tr:hover .action-icon {
    opacity: 1;
}
/* Hover efek untuk ikon aktif */
.action-icon:hover {
    color: red;
    background-color: #e0e0e0;
}
/* Disabled icon – tidak bisa diklik dan tidak bereaksi saat hover */
.action-icon.disabled {
    pointer-events: none;
    color: #bbb !important;
    background-color: transparent !important;
}

.sticky-header th { 
    position: sticky; 
    top: 0; 
    background-color: #003366; 
    color: white; 
    z-index: 2; 
}
.title-box { 
    background-color: #003366; 
    color: white; 
    padding: 10px 15px; 
    border-radius: 5px; 
    display: flex; 
    align-items: center; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
}
.title-box i { margin-right: 10px; }
.button-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
    margin: 15px 0; 
}
.btn-group-vertical-responsive { 
    display: flex; 
    flex-direction: row; 
    gap: 10px; 
}
@media (max-width: 591.98px) {
    .btn-group-vertical-responsive { 
        flex-direction: column; 
    }
    .btn-group-vertical-responsive button, .btn-group-vertical-responsive a { 
        width: 100% !important; 
    }
}
.table-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
}
.table-wrapper { 
    max-height: 450px; 
    overflow-y: auto; 
}

/* Notifikasi Message Box */
.notification-message {
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: medium;
    display: none;
}
.notification-error { background-color: #d9534f; color: white; }
.notification-success { background-color: #0275d8; color: white; }
.notification-warning { background-color: #f0ad4e; color: black; }

/* Spinner Untuk tabel user */
.loading-overlay {
  position: absolute;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

</style>
</head>

<body class="p-2 p-sm-3">
<div class="container">

<div class="title-box mb-3">
    <i class="fas fa-user-cog fa-lg"></i>
    <h6 class="mb-0">Setup User</h6>
</div>

<div class="button-box d-flex justify-content-between align-items-center btn-group-vertical-responsive">
    <button class="btn btn-primary" id="addUserButton"><i class="fas fa-plus"></i> Add User</button>
    <a href="https://amihaji.github.io/kitworks/index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Close</a>
</div>
<div id="notificationBox" class="notification-message"></div>
    <div class="table-box">
        <div class="table-wrapper">
        <table class="table table-hover table-striped table-bordered align-middle text-center">
            <thead class="sticky-header">
                <tr>
                    <th>User ID</th>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>HP</th>
                    <th>Pass</th>
                    <th>Level</th>
                    <th>Salah</th>
                    <th>Log</th>
                    <th>Set</th>
                    <th>Flc</th>
                    <th>Est</th>
                    <th>We</th>
                    <th>Fol</th>
                    <th>Crm</th>
                    <th class="actions-col">Aksi</th>
                </tr>
            </thead>
            <tbody id="userTableBody"><tr><td colspan="15">Memuat data...</td></tr></tbody>
            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay" style="display:none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading Data...</span>
                </div>
            </div>
        </table>
        </div>
    </div>
</div>

<!-- Modal Add/Edit -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<form id="userForm" class="modal-content">
    <div class="modal-header" style="background-color:#003366; color:white;">
        <h6 class="modal-title">Tambah User</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <input type="hidden" id="mode" value="add">
        <div class="mb-2"><label>User ID</label><input type="text" id="userId" class="form-control" required></div>
        <div class="mb-2"><label>Nama User</label><input type="text" id="userName" class="form-control" required></div>
        <div class="mb-2"><label>Email</label><input type="email" id="userEmail" class="form-control" required></div>
        <div class="mb-2"><label>HP</label><input type="text" id="userHP" class="form-control" required></div>
        <div class="mb-2"><label>Password</label><input type="text" id="userPass" class="form-control" required></div>
        <div class="mb-2"><label>Level</label>
            <select id="userLevel" class="form-select" required>
                <option value="Admin">Admin</option>
                <option value="Member">Member</option>
                <option value="User">User</option>
            </select>
        </div>
        <div class="mb-2"><label>Salah</label><input type="number" id="userSalah" class="form-control" value="0" min="0" max="3" required></div>
        <div class="mb-2"><label>Hak Akses (Y/N)</label><div class="row g-2">
            <div class="col"><input type="text" id="aksesLogin" class="form-control" placeholder="Login" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesSetting" class="form-control" placeholder="Setting" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesFLC" class="form-control" placeholder="FLC" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesEstiH" class="form-control" placeholder="EstiH" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesWE" class="form-control" placeholder="WE" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesFollowup" class="form-control" placeholder="Followup" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesCRM" class="form-control" placeholder="CRM" maxlength="1" required></div>
        </div></div>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Simpan</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
    </div>
</form>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<SCRIPT>
// ********* Deklarasi  Public **********
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbwJUBnUrtKsH5Z5onko_Q4orQWva0VA8wnRefJWDnGjeBdMjomvpld6vuLynXlYCqDrbg/exec';
// **************************************

// Tampilkan Loading Overlay
function showLoading(show) {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = show ? 'flex' : 'none';
}

// LOAD DATA USER
function loadUserTable() {
    showLoading(true);  // Tambah ini
    const callbackName = 'cb_' + Date.now();
    const script = document.createElement('script');
    script.src = `${URL_APPS_SCRIPT}?action=getTabelUser&callback=${callbackName}`;

    window[callbackName] = function(data) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="14">Tidak ada data user.</td></tr>';
            showLoading(false);  // Tambah ini
            return;
        }

        data.forEach(row => {
            const [userId, namaUser, emailUser, hpUser, passUser, levelUser, salah,
                login, setting, flc, estih, we, followup, crm] = row;

            let editState   = '';
            let deleteState = '';
            let unlockState = 'disabled';
            let kirimState  = 'disabled';

            const salahCount = parseInt(salah) || 0;
            const unlockFlag = localStorage.getItem('notifReady_' + userId);

            if (salahCount >= 3) {
                editState   = 'disabled';
                deleteState = 'disabled';
                unlockState = '';
                kirimState  = 'disabled';
            } else if (unlockFlag === 'true') {
                editState   = 'disabled';
                deleteState = 'disabled';
                unlockState = 'disabled';
                kirimState  = '';
            }

            const tr = document.createElement('tr');
            tr.id = `row_${userId}`; // Untuk mengupdate baris record di tabel 

            tr.innerHTML = `
                <td>${userId}</td>
                <td>${namaUser}</td>
                <td>${emailUser}</td>
                <td>${hpUser}</td>
                <td>${passUser}</td>
                <td>${levelUser}</td>
                <td>${salah}</td>
                <td>${login}</td>
                <td>${setting}</td>
                <td>${flc}</td>
                <td>${estih}</td>
                <td>${we}</td>
                <td>${followup}</td>
                <td>${crm}</td>
                <td class="actions-col">
                    <i class="fas fa-edit action-icon ${editState}" title="Edit User" onclick="editUser('${userId}')"></i>
                    <i class="fas fa-trash-alt action-icon ${deleteState}" title="Hapus User" onclick="deleteUser('${userId}')"></i>
                    <i class="fas fa-unlock action-icon ${unlockState}" title="Unlock User" onclick="unlockUser('${userId}')"></i>
                    <i class="fas fa-paper-plane action-icon ${kirimState}" title="Kirim Notifikasi" onclick="sendNotif('${userId}','${namaUser}','${emailUser}','${hpUser}','${passUser}')"></i>
                </td>
            `;

            tbody.appendChild(tr);
        });
        showLoading(false);  // Tambah ini 
        delete window[callbackName];
        document.body.removeChild(script);
    };

    script.onerror = function() {
        //alert('Gagal mengambil data user');
        showNotification('error', 'Gagal mengambil data user!');
        showLoading(false);  // Tambah ini
        delete window[callbackName];
    };

    document.body.appendChild(script);
}

// ADD & EDIT USER
document.getElementById('userForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const mode = document.getElementById('mode').value;
  const payload = {
    action: mode === 'add' ? 'addUser' : 'editUser',
    userId: document.getElementById('userId').value.trim(),
    userName: document.getElementById('userName').value.trim(),
    userEmail: document.getElementById('userEmail').value.trim(),
    userHP: document.getElementById('userHP').value.trim(),
    userPass: document.getElementById('userPass').value.trim(),
    userLevel: document.getElementById('userLevel').value.trim(),
    userSalah: document.getElementById('userSalah').value.trim(),
    aksesLogin: document.getElementById('aksesLogin').value.trim().toUpperCase(),
    aksesSetting: document.getElementById('aksesSetting').value.trim().toUpperCase(),
    aksesFLC: document.getElementById('aksesFLC').value.trim().toUpperCase(),
    aksesEstiH: document.getElementById('aksesEstiH').value.trim().toUpperCase(),
    aksesWE: document.getElementById('aksesWE').value.trim().toUpperCase(),
    aksesFollowup: document.getElementById('aksesFollowup').value.trim().toUpperCase(),
    aksesCRM: document.getElementById('aksesCRM').value.trim().toUpperCase()
  };
  fetch(URL_APPS_SCRIPT, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        loadUserTable();
      } else {
        //alert('Gagal menyimpan data');
        showNotification('warning', 'Gagal menyimpnan data!');
      }
    });
});

// EDIT USER MODAL
function editUser(...fields) {
  const [id, name, email, hp, pass, level, salah, login, setting, flc, estih, we, followup, crm] = fields;
  document.getElementById('mode').value = 'edit';
  document.getElementById('userId').value = id; document.getElementById('userId').readOnly = true;
  document.getElementById('userName').value = name;
  document.getElementById('userEmail').value = email;
  document.getElementById('userHP').value = hp;
  document.getElementById('userPass').value = pass;
  document.getElementById('userLevel').value = level;
  document.getElementById('userSalah').value = salah;
  document.getElementById('aksesLogin').value = login;
  document.getElementById('aksesSetting').value = setting;
  document.getElementById('aksesFLC').value = flc;
  document.getElementById('aksesEstiH').value = estih;
  document.getElementById('aksesWE').value = we;
  document.getElementById('aksesFollowup').value = followup;
  document.getElementById('aksesCRM').value = crm;
  new bootstrap.Modal(document.getElementById('userModal')).show();
}

// DELETE USER
function deleteUser(userId) {
  if (confirm(`Hapus user ${userId}?`)) {
    fetch(URL_APPS_SCRIPT, {
      method: 'POST',
      body: JSON.stringify({ action: 'deleteUser', userId }),
      headers: { 'Content-Type': 'application/json' }
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          loadUserTable();
        } else {
          // alert('Gagal menghapus user');
          showNotification('warning', 'Gagal menghapus data!');
          
        }
      });
  }
}

document.addEventListener('DOMContentLoaded', loadUserTable);
document.getElementById('addUserButton').addEventListener('click', () => {
  document.getElementById('mode').value = 'add';
  document.getElementById('userForm').reset();
  document.getElementById('userId').readOnly = false;
  new bootstrap.Modal(document.getElementById('userModal')).show();
});

function unlockUser(userId) {
  if (!confirm("Anda yakin untuk unlock user ini?")) return;
  const callbackName = 'cbUnlock_' + Date.now();
  window[callbackName] = (res) => {
    if (res.status === 'success') {
      // alert(res.message);
      showNotification('success', res.message);
      localStorage.setItem('notifReady_' + userId, 'true');
      const row = document.getElementById(`row_${userId}`);
      if (row) {
        const cols = row.getElementsByTagName('td');
        if (cols.length >= 7) cols[6].textContent = '0';
        row.querySelector('.fa-edit')?.classList.add('disabled');
        row.querySelector('.fa-trash-alt')?.classList.add('disabled');
        row.querySelector('.fa-unlock')?.classList.add('disabled');
        row.querySelector('.fa-paper-plane')?.classList.remove('disabled');
      }
    //} else alert("Reset Login gagal: " + res.message);
    } else showNotification('error', "Reset Login gagal: " + res.message);
      delete window[callbackName];
  };
  const script = document.createElement('script');
  script.src = `${URL_APPS_SCRIPT}?action=unlockUser&userId=${encodeURIComponent(userId)}&callback=${callbackName}`;
  document.body.appendChild(script);
}

function sendNotif(userId, userName, userEmail, userHP, userPass) {
    console.log("Mengirim notifikasi ke:", userId, userName, userEmail, userHP, userPass);

    const callback = 'cb_' + Date.now();
    const script = document.createElement('script');
    script.src = `${URL_APPS_SCRIPT}?action=sendNotifUser` +
        `&userId=${encodeURIComponent(userId)}` +
        `&userName=${encodeURIComponent(userName)}` +
        `&userEmail=${encodeURIComponent(userEmail)}` +
        `&userHP=${encodeURIComponent(userHP)}` +
        `&userPass=${encodeURIComponent(userPass)}` +
        `&callback=${callback}`;

    window[callback] = function (response) {
        console.log("Respon kirim:", response);
        if (response.status === 'success') {
            //alert("✅ " + response.message);
            showNotification('success', "Berhasil " + response.message);
            localStorage.removeItem('notifReady_' + userId);
            loadUserTable(); // reload tampilan icon
        } else {
            //alert("❌ " + response.message);
            showNotification('error', "Gagal " + response.message);
        }

        delete window[callback];
        document.body.removeChild(script);
    };

    script.onerror = () => {
        // alert("Gagal terhubung ke server");
        showNotification('error', "Gagal terhubung ke server");
        delete window[callback];
        document.body.removeChild(script);
    };

    document.body.appendChild(script);
}

function updateRowIcons(row, mode) {
    const icons = row.querySelectorAll('.action-icon');

    const [editIcon, delIcon, unlockIcon, kirimIcon] = icons;

    if (mode === 'unlock') {
        editIcon.classList.add('disabled');
        delIcon.classList.add('disabled');
        unlockIcon.classList.add('disabled');
        kirimIcon.classList.remove('disabled');
    } else if (mode === 'kirim') {
        editIcon.classList.remove('disabled');
        delIcon.classList.remove('disabled');
        unlockIcon.classList.add('disabled');
        kirimIcon.classList.add('disabled');
    }
}

function showNotification(type, message, duration = 3000) {
    const box = document.getElementById('notificationBox');
    box.className = 'notification-message'; // reset class
    if (type === 'error') box.classList.add('notification-error');
    else if (type === 'success') box.classList.add('notification-success');
    else if (type === 'warning') box.classList.add('notification-warning');

    box.innerText = message;
    box.style.display = 'block';

    setTimeout(() => { box.style.display = 'none'; }, duration);
}

</SCRIPT>
</body>
</html>
