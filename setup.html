<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setup User - WE Tools</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body { 
    background-color: #f8f9fa; 
}
.table-hover tbody tr:hover { 
    background-color: #f2f2f2; 
    cursor: pointer; 
}
.actions-col { 
    width: 220px; 
    text-align: center; 
    white-space: nowrap; 
}
.action-icon { 
    display: inline-flex; 
    justify-content: center; 
    align-items: center; 
    width: 25px; 
    height: 25px; 
    opacity: 0; 
    transition: opacity 0.2s; 
    margin: 0 5px; 
    cursor: pointer; 
    color: #6c757d; 
    border-radius: 50%; 
    padding: 4px; 
}
tr:hover .action-icon { 
    opacity: 1; 
}
.action-icon:hover { 
    color: red; 
    background-color: #e0e0e0; 
}
.sticky-header th { 
    position: sticky; 
    top: 0; 
    background-color: #003366; 
    color: white; 
    z-index: 2; 
}
.title-box { 
    background-color: #003366; 
    color: white; 
    padding: 10px 15px; 
    border-radius: 5px; 
    display: flex; 
    align-items: center; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
}
.title-box i { margin-right: 10px; }
.button-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
    margin: 15px 0; 
}
.btn-group-vertical-responsive { 
    display: flex; 
    flex-direction: row; 
    gap: 10px; 
}
@media (max-width: 591.98px) {
    .btn-group-vertical-responsive { 
        flex-direction: column; 
    }
    .btn-group-vertical-responsive button, .btn-group-vertical-responsive a { 
        width: 100% !important; 
    }
}
.table-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
}
.table-wrapper { 
    max-height: 450px; 
    overflow-y: auto; 
}
</style>
</head>

<body class="p-2 p-sm-3">
<div class="container">

<div class="title-box mb-3">
    <i class="fas fa-user-cog fa-lg"></i>
    <h6 class="mb-0">Setup User</h6>
</div>

<div class="button-box d-flex justify-content-between align-items-center btn-group-vertical-responsive">
    <button class="btn btn-primary" id="addUserButton"><i class="fas fa-plus"></i> Add User</button>
    <a href="https://amihaji.github.io/kitworks/index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Close</a>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div class="table-box">
    <div class="table-wrapper">
        <table class="table table-hover table-striped table-bordered align-middle text-center">
            <thead class="sticky-header">
                <tr>
                    <th>User ID</th>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>HP</th>
                    <th>Pass</th>
                    <th>Level</th>
                    <th>Salah</th>
                    <th>Login</th>
                    <th>Setting</th>
                    <th>FLC</th>
                    <th>EstiH</th>
                    <th>WE</th>
                    <th>Followup</th>
                    <th>CRM</th>
                    <th class="actions-col">Aksi</th>
                </tr>
            </thead>
            <tbody id="userTableBody"><tr><td colspan="15">Memuat data...</td></tr></tbody>
        </table>
    </div>
</div>
</div>


  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
<!-- Modal Add/Edit -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<form id="userForm" class="modal-content">
    <div class="modal-header" style="background-color:#003366; color:white;">
        <h6 class="modal-title">Tambah User</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <input type="hidden" id="mode" value="add">
        <div class="mb-2"><label>User ID</label><input type="text" id="userId" class="form-control" required></div>
        <div class="mb-2"><label>Nama User</label><input type="text" id="userName" class="form-control" required></div>
        <div class="mb-2"><label>Email</label><input type="email" id="userEmail" class="form-control" required></div>
        <div class="mb-2"><label>HP</label><input type="text" id="userHP" class="form-control" required></div>
        <div class="mb-2"><label>Password</label><input type="text" id="userPass" class="form-control" required></div>
        <div class="mb-2"><label>Level</label>
            <select id="userLevel" class="form-select" required>
                <option value="Admin">Admin</option>
                <option value="Member">Member</option>
                <option value="User">User</option>
            </select>
        </div>
        <div class="mb-2"><label>Salah</label><input type="number" id="userSalah" class="form-control" value="0" min="0" max="3" required></div>
        <div class="mb-2"><label>Hak Akses (Y/N)</label><div class="row g-2">
            <div class="col"><input type="text" id="aksesLogin" class="form-control" placeholder="Login" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesSetting" class="form-control" placeholder="Setting" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesFLC" class="form-control" placeholder="FLC" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesEstiH" class="form-control" placeholder="EstiH" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesWE" class="form-control" placeholder="WE" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesFollowup" class="form-control" placeholder="Followup" maxlength="1" required></div>
            <div class="col"><input type="text" id="aksesCRM" class="form-control" placeholder="CRM" maxlength="1" required></div>
        </div></div>
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Simpan</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
    </div>
</form>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<SCRIPT>
// ********* Deklarasi  Public **********
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbypSUXNHfgWvnBR6VrOolL3VpGKCDCJBRug7PcQ16X02ipwxENspffS601OQAUFY6Qzjg/exec';
// **************************************

// Tampilkan Loading Overlay
function showLoading(show) {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = show ? 'flex' : 'none';
}

// LOAD DATA USER
function loadUserTable() {
  showLoading(true);
  const callbackName = 'cb_' + Date.now();
  const script = document.createElement('script');
  script.src = `${URL_APPS_SCRIPT}?action=getTabelUser&callback=${callbackName}`;

  window[callbackName] = function (data) {
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="15">Tidak ada data user.</td></tr>';
    } else {
      data.forEach(row => {
        let html = '<tr>';
        row.forEach(cell => html += `<td>${cell}</td>`);
        html += '</tr>';
        tbody.innerHTML += html;
      });
    }

    showLoading(false);
    document.body.removeChild(script);
    delete window[callbackName];
  };

  script.onerror = () => {
    alert('Gagal mengambil data.');
    showLoading(false);
  };

  document.body.appendChild(script);
}


// ADD & EDIT USER
document.getElementById('userForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const mode = document.getElementById('mode').value;
  const payload = {
    action: mode === 'add' ? 'addUser' : 'editUser',
    userId: document.getElementById('userId').value.trim(),
    userName: document.getElementById('userName').value.trim(),
    userEmail: document.getElementById('userEmail').value.trim(),
    userHP: document.getElementById('userHP').value.trim(),
    userPass: document.getElementById('userPass').value.trim(),
    userLevel: document.getElementById('userLevel').value.trim(),
    userSalah: document.getElementById('userSalah').value.trim(),
    aksesLogin: document.getElementById('aksesLogin').value.trim().toUpperCase(),
    aksesSetting: document.getElementById('aksesSetting').value.trim().toUpperCase(),
    aksesFLC: document.getElementById('aksesFLC').value.trim().toUpperCase(),
    aksesEstiH: document.getElementById('aksesEstiH').value.trim().toUpperCase(),
    aksesWE: document.getElementById('aksesWE').value.trim().toUpperCase(),
    aksesFollowup: document.getElementById('aksesFollowup').value.trim().toUpperCase(),
    aksesCRM: document.getElementById('aksesCRM').value.trim().toUpperCase()
  };
  fetch(URL_APPS_SCRIPT, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
        loadUserTable();
      } else {
        alert('Gagal menyimpan data');
      }
    });
});

// EDIT USER MODAL
function editUser(...fields) {
  const [id, name, email, hp, pass, level, salah, login, setting, flc, estih, we, followup, crm] = fields;
  document.getElementById('mode').value = 'edit';
  document.getElementById('userId').value = id; document.getElementById('userId').readOnly = true;
  document.getElementById('userName').value = name;
  document.getElementById('userEmail').value = email;
  document.getElementById('userHP').value = hp;
  document.getElementById('userPass').value = pass;
  document.getElementById('userLevel').value = level;
  document.getElementById('userSalah').value = salah;
  document.getElementById('aksesLogin').value = login;
  document.getElementById('aksesSetting').value = setting;
  document.getElementById('aksesFLC').value = flc;
  document.getElementById('aksesEstiH').value = estih;
  document.getElementById('aksesWE').value = we;
  document.getElementById('aksesFollowup').value = followup;
  document.getElementById('aksesCRM').value = crm;
  new bootstrap.Modal(document.getElementById('userModal')).show();
}

// DELETE USER
function deleteUser(userId) {
  if (confirm(`Hapus user ${userId}?`)) {
    fetch(URL_APPS_SCRIPT, {
      method: 'POST',
      body: JSON.stringify({ action: 'deleteUser', userId }),
      headers: { 'Content-Type': 'application/json' }
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          loadUserTable();
        } else {
          alert('Gagal menghapus user');
        }
      });
  }
}

document.addEventListener('DOMContentLoaded', loadUserTable);
document.getElementById('addUserButton').addEventListener('click', () => {
  document.getElementById('mode').value = 'add';
  document.getElementById('userForm').reset();
  document.getElementById('userId').readOnly = false;
  new bootstrap.Modal(document.getElementById('userModal')).show();
});

</SCRIPT>
</body>
</html>
